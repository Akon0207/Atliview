<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>aTLi-T100</title>
<meta name="keywords" content="aTLi-T100" />
<meta name="description" content="aTLi-T100" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta content="telephone=no" name="format-detection">
<link rel="stylesheet" type="text/css" href="style/css/swiper.min.css" />
<link rel="stylesheet" type="text/css" href="style/css/mobiscroll.custom-3.0.0-beta2.min.css" />
<link rel="stylesheet" type="text/css" href="style/css/main.css" />
<link rel="stylesheet" type="text/css" href="style/css/folder.css">
<script type="text/javascript" src="js/swiper.min.js"></script>
<script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="js/mobiscroll.custom-3.0.0-beta2.min.js"></script>
<script type="text/javascript" src="js/swiper.min.js"></script>
<script type="text/javascript" src="js/device.min.js"></script>
<script type="text/javascript" src="js/crypto-js.min.js"></script>
<script type="text/javascript" src="js/enc-base64.min.js"></script>
<script type="text/javascript" src="js/hmac-sha256.min.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script src="js/Blob.js"></script>
<script src="js/StreamSaver.js"></script>
<script src="js/zip-stream.js"></script>
<script src="js/axios.min.js"></script>
</head>
<body class="video-index">
	<section class="setting-head">
		<a href="video.html" class="iconfont goback">&#xe6ea;</a>
		<p lan="photoFolder">图片文件夹</p>
		<!-- <button id="$start">Start</button>
		<span id="downloadProgress">0/0</span> -->
		<a href="javascript:;" class="iconfont folder-slice" style="display: none;"><img src="images/timeslice_icon.png"></a>
		<a href="javascript:;" class="iconfont folder-download">&#xe644;</a>
		<a href="javascript:;" class="iconfont folder-delete">&#xe634;</a>
	<!--	<div class="video-style" id="firmware"></div> -->
</section>
	<section class="setting-head head-msg">
		<p lan="foladr-head-msg">总数量0帧，抽样显示0帧</p>
		<a href="javascript:;" class="iconfont folder-setting">&#xe6e9;</a>

	</section>

	<section class="video-list" id="mediaList">
		<ul>
		</ul>
	</section>
	<div class="outPutMode slice">
        <section class="wlan-detail">
                <a href="javascript:;" class="iconfont cancel">&#xe6ea;</a>
                <div class="wlan-detail-name bottom-line" lan="CreatingTimeSlicePhoto">渐现</div>
		<div class="wlan-detail-tit" id="range-msg" lan="ImageSetRange">范围</div>
<div class="container">
	<img class="longImg" src="images/horizontal_2.png">
	<div class="slider">
        <div class="track"></div>
    </div>
    <div class="output o0"><input type="number" id="range-start"></div>
    <div class="thumb t0"><div></div></div>

    <div class="output o1"><input type="number" id="range-end"></div>
    <div class="thumb t1"><div></div></div>
</div>

		<div class="wlan-detail-tit" lan="SlicingSamples">数量</div>
		<div class="choose-pics">
		<span class="outputRange">12</span><input type="range" id="slice_count" value="12" min="8" max="200" step="1"><img class="plusMinus plus" src="images/plus.png "><img class="plusMinus minus" src="images/minus.png ">
		</div>
		<!--
                <div class="wlan-detail-tit" >切片数量</div>
                                <div class="setting-current choose-pics">
                                        <div class="swiper-container">
                                                <div class="swiper-wrapper">
                                                        <div class="swiper-slide">12</div>
                                                        <div class="swiper-slide">18</div>
                                                        <div class="swiper-slide on">24</div>
                                                        <div class="swiper-slide">36</div>
                                                        <div class="swiper-slide">48</div>
                                                        <div class="swiper-slide">60</div>
                                                        <div class="swiper-slide"><input type="number" class="count" placeholder="自定义" onFocus="this.placeholder=''" onBlur="this.placeholder='自定义'" min="1"></div>
                                                </div>
                                        </div>
                                </div>  
								-->
                <div class="wlan-detail-tit" ><div class="orderNmae" lan="SlicingOrder">顺序</div><div class="orderText"><span lan="Forward">默认</span><img src="images/arrow_more.png"></div></div>
				<!--
                                <div class="setting-current choose-order">
                                        <div class="swiper-container">
                                                <div class="swiper-wrapper">
                                                        <div class="swiper-slide on">正向</span></div>
                                                        <div class="swiper-slide">反向</span></div>
                                                </div>
                                        </div>
                                </div>  
								-->

                <div class="wlan-detail-tit" lan="Style">风格</div>
                                <div class="setting-current choose-style">
                                        <div class="swiper-container">
                                                <div class="swiper-wrapper">
                                                        <div class="swiper-slide2 on"><img class="horizontal" src="images/horizontal_0.png"><img class="select" src="images/select_style.png"></div>
                                                        <div class="swiper-slide2"><img class="horizontal" src="images/horizontal_1.png"><img class="select" src="images/select_style.png"></div>
                                                        <div class="swiper-slide2"><img class="horizontal" src="images/horizontal_2.png"><img class="select" src="images/select_style.png"></div>
                                                        <div class="swiper-slide2"><img class="horizontal" src="images/horizontal_3.png"><img class="select" src="images/select_style.png"></div>
                                                </div>
                                        </div>
                                </div>  


                <div class="choose-btn" lan="Start">生成</div>
      </section>
	</div>

	<div class="outPutMode settings">
		<section class="setting-head">
		<a href="javascript:;" class="iconfont goback setting-goback">&#xe6ea;</a>
		<p lan="Display">显示比例</p>
		
	  </section>
		<ul>
			<li v=1><i lan="total">全部</i><i class="show-count">可展示0帧</i></li>
			<li v=2><i>1/2抽样</i><i class="show-count">可展示0帧</i></li>
			<li v=5><i>1/5抽样</i><i class="show-count">可展示0帧</i></li>
			<li class="on" v=10><i>1/10抽样</i><i class="show-count">可展示0帧</i></li>
			<li v=25><i>1/25抽样</i><i class="show-count">可展示0帧</i></li>
			<li v=50><i>1/50抽样</i><i class="show-count">可展示0帧</i></li>
			<li v=100><i>1/100抽样</i><i class="show-count">可展示0帧</i></li>
			<li v=200><i>1/200抽样</i><i class="show-count">可展示0帧</i></li>
		</ul>
	</div>

	<div class="outPutMode order">
		<section class="setting-head">
		<a href="javascript:;" class="iconfont goback order-goback">&#xe6ea;</a>
		<p lan="SlicingOrder">顺序</p>
		
	  </section>
		<ul>
			<div v=0 class="order-line"><div class="order-name"><p lan="Forward">默认</p><img v=0 class="tick on" src="images/tick.png"></div><div  class="order-info" lan="LeftToRing">根据素材照片的先后时间，从左至右排列</div></div>
			<div v=1 class="order-line"><div class="order-name"><p lan="Reverse">倒序</p><img v=1 class="tick" src="images/tick.png"></div><div  class="order-info" lan="RightToLeft">根据素材照片的先后时间，从右至左排列</div></div>
		</ul>
	</div>

    <div class="dialog-cover"></div>

    <div class="dialog-poppup" id="deleteFolder" style="display: none;">
     <div class="dialog-poppup-content" lan="msdelFolder">是否要删除文件夹?</div>
     <div class="dialog-btns flex">
       <a href="javascript:;" class="downloadCancel" lan="cancel">取消</a>
       <a href="javascript:;" id="deleteFolderConfirm" lan="OK">确定</a>
     </div>
    </div>

    <div class="dialog-poppup" id="downloadPack" style="display: none;">

     <div class="dialog-poppup-content" lan="dlFolderPicture">是否要下载该文件夹中的图片?</div>
     <div class="dialog-btns flex">
       <a href="javascript:;" class="downloadCancel" lan="cancel">取消</a>
       <a href="javascript:;" id="downloadConfirm" lan="OK">确定</a>
     </div>
    </div>
	<div class="dialog-poppup" id="showMsg" style="display: none;">
		<div class="dialog-poppup-content" lan="delsuc"></div>
		<div class="dialog-btns flex">
		 <a href="javascript:;" id="showMsgConfirm" lan="OK">确定</a>
		</div>
	</div>

	<div class="dialog-poppup" id="downloadError" style="display: none;">
		<div class="dialog-poppup-content" lan="FailedToCompressFolder">压缩文件夹失败!</div>
		<div class="dialog-btns flex">
		 <a href="javascript:;" id="downloadErrorConfirm" lan="OK">确定</a>
		</div>
	</div>
	<div class="dialog-poppup" id="packing" style="display: none;">
		<div class="dialog-poppup-content" id="packSecMsg"></div>
        <div style="font-size: 16px;color: #999;text-align: center;margin: 0px 0 15px 0;" lan="packPro"></div>
		<div class="dialog-btns flex">
		</div>
	</div>
	<div class="dialog-poppup" id="slicing" style="display: none;">
		<div class="dialog-poppup-content" id="sliceSecMsg" lan="TimeSliceProcessing">正在处理...</div>
		<div class="dialog-btns flex">
		</div>
	</div>
	<div class="dialog-poppup" id="sliceResult" style="display: none;">
		<div class="dialog-poppup-content" id="sliceResultMsg" lan="TimeSliceFailed">切片失败!</div>
		<div class="dialog-btns flex">
		 <a href="javascript:;" id="sliceResultConfirm" lan="OK">确定</a>
		</div>
	</div>
    <div class="phonePrompt" id="phonePrompt">
        <div class="content" lan="phonePrompt">请在电脑下载图组文件夹</div>
        <div class="btn">
            <a href="javascript:;" id="phoneConfirm" lan="confirm">确定</a>
        </div>
    </div>
    <div class="beforeDownload" id="beforeDownload">
        <!-- <div class="title" lan="warning">提示</div> -->
        <div class="content">本次下载将占用大约xxGB的内存空间，请确保足够的磁盘空间。</div>
        <div class="btn flex">
            <a href="javascript:;" lan="cancel" id="downloadCancel">取消</a>
            <a href="javascript:;" lan="download" id="downloadYes">下载</a>
        </div>
    </div>
    <div class="downloadPrepare">
        <div class="preparing">
            <div class="ball-circle">
                <div class="ball"></div>
                <div class="ball"></div>
                <div class="ball"></div>
                <div class="ball"></div>
                <div class="ball"></div>
                <div class="ball"></div>
                <div class="ball"></div>
                <div class="ball"></div>
            </div>
        </div>
        <div class="preContent" lan="preparing">正在准备下载...</div>
    </div>
    <div class="downloading" id="downloading">
        <div class="title" lan="progressTit">下载进度</div>
        <div class="progress">
            <div class="progressDiv">
                <span class="progressSpan"></span>
            </div>
            <div class="progressCount"><span id="comCount">0</span>/<span id="totalCount">0</span></div>
        </div>
        <div class="progressText">正在下载...</div>
        <div class="failCount">其中有5张照片下载失败</div>
        <div class="downloadPrompt" lan="downloadPrompt">下载期间切勿离开或关闭本页面</div>
        <div class="btn">
            <a href="javascript:;" lan="confirm" id="doneConfirm">确定</a>
        </div>
    </div>
    <!-- <div class="dialog-poppup folderPrompt" id="dlfolderPrompt">
        <div class="title">提示</div>
        <div class="content">正在批量下载图组文件夹，离开此页面将中断下载。确认要离开或关闭页面？</div>
        <div class="btn">
            <a href="javascript:;" id="downloadContinue">取消</a>
            <a href="javascript:;" id="downloadCancel">确定</a>
        </div>
    </div> -->
<script type="text/javascript" src="js/language.js"></script>
<script type="text/javascript">
$(function(){
	//选择排列方式

	$(".iconfont.goback").attr("href","video.html?language="+language)
	$(".folder-setting").on('click', function(){
		$(".outPutMode.settings").show();
	})
	$(".setting-goback, .iconfont.cancel").on('click', function(){
		$(".outPutMode").hide();
		return false;
	})
	$(".order-goback").on("click", function(){  //设定顺序页面
		$(".outPutMode.order").hide();
		return false;
	})
	$(".orderText").on("click", function(){  //设定顺序页面
		$(".outPutMode.order").show();
	})
	$(".order-line").on("click", function(){  //点击设定顺序
		var v = $(this).attr("v");
		$(".tick").hide();
		$(".tick[v="+v+"]").show().addClass("on").siblings().removeClass("on");
		if(v==0){
			if(language=="en") $(".orderText span").html("Forward");
			else $(".orderText span").html("默认");
		}else {
			if(language=="en") $(".orderText span").html("Reverse");
			else $(".orderText span").html("倒序");
		}
		setTimeout(function (){$(".outPutMode.order").hide();}, 200);
	})
	$(".outPutMode li").each(function(index){
		$(this).on("click",function(e){
			if($(this).attr("v") == folderShowItems) setTimeout(function(){$(".outPutMode").hide()}, 200);
			else {
				$(this).addClass("on").siblings().removeClass("on");
				localControl.putValue("folderShowItems", $(this).attr("v"));
				location.href = "/folder.html?id="+id+"&language="+language+"&c="+$(this).attr("v")+(getAccessToken()?'&access_token='+getAccessToken():'');
				//location.reload();
			}
		})
	})
	$(".swiper-slide").each(function(e){
		$(this).click(function(){
			$(this).addClass("on").siblings().removeClass("on");
		});
	});
	$(".swiper-slide2").each(function(e){
		$(this).click(function(){
			$(this).addClass("on").siblings().removeClass("on");
			$(this).children(".select").show();
			$(this).siblings().children(".select").hide();
			
		});
	});
	$(".swiper-slide2.on").children(".select").show();
	$(".longImg").attr("src", '/media/'+id+'/thumbnail/slider.jpg' + (getAccessToken()?'?access_token='+getAccessToken():''));
	$(".tick[v=1]").hide();

var id = getParameterByName('id');
var folderShowItems = parseInt(localControl.getValue("folderShowItems", 10));
//$("li[v="+folderShowItems+"]").addClass("on").siblings().removeClass("on");
var url=false;
var maxItems = 0;
const maxIndex = 0;
var showItems = 0;
var mediaData=[];
var index = 0;
var recount = 0;
var byMonthObj = {},
	byDateObj = {};



var packID=null;
function setMiddle(id, v)
{
	$(".dialog-poppup").hide();
	if(v) $(id+" .dialog-poppup-content").html(v);
	$(id).css("top",($(window).height() - $(id).outerHeight())/2 + $(document).scrollTop()).show();
	$(".dialog-cover").css("top",($(window).height() - $(".dialog-cover").outerHeight())/2 + $(document).scrollTop()).show();
}


function deleteFolder()
{
	putJSON("/webctl", {"deleteFolder" : id}, function(e){
		setMiddle("#showMsg", "Delete folder successfully");
		$("#showMsgConfirm").one("click", function(){location.href = "video.html"});
		//setTimeout(function(){location.href = "video.html"}, 1000);
	},function(jqXHR, exception){
		setMiddle("#showMsg", "Failed to delete folder, HTTP return:"+jqXHR.status);
		console.log((jqXHR.status+exception));
	}, "text");
}
$(".folder-delete").on('click', function(){
	setMiddle("#deleteFolder");
});
$("#deleteFolderConfirm").on('click', function(){
	deleteFolder();
});

function timeout()
{
	setMiddle("#downloadError");
	//setMiddle(".dialog-cover");
	//$("#downloadError, .dialog-cover").show();
	console.log("打包超时");
}
function downloadPack()
{
	$(".dialog-poppup,.dialog-cover").hide();
	var link = document.createElement('a');
	link.setAttribute("download", "");
	link.href = "/media/"+packID+".tgz"+(getAccessToken()?'?access_token='+getAccessToken():'');
	link.click();
	setTimeout(function(){postJSON("/tgz", {rm:packID+".tgz"})}, 1000);
}
var packSec=0;
var packMacSec=60;
var allAmount=0;
function checkPack()
{
	if(packSec > packMacSec) return timeout();
	getJSON("/tgz", function(e, status){
        // if(language=="en"){
        //     $("#packSecMsg").html("Compressing "+packMacSec+" Photos，about "+packSec+" seconds");
        // }else{
        //     $("#packSecMsg").html("正在压缩"+packMacSec+"张照片，已用时"+packSec+"秒");
        // }
		if(language=="en"){
            $("#packSecMsg").html("<img src=\"images/netprompt.gif\">Compressing files...");
        }else{
            $("#packSecMsg").html("<img src=\"images/netprompt.gif\">正在压缩文件...");
        }
		console.log("总计"+packMacSec+"张图片压缩中，已用时"+packSec+"秒 "+e.tgz);
		packSec++;
		if(e.tgz != packID ) {
			setMiddle("#downloadError");
			//setMiddle(".dialog-cover");
			//$("#downloadError, .dialog-cover").show();
			console.log("打包ID错误");
		}
		else if(e.status == "done") {
			console.log("打包成功");
			downloadPack();
		}
		else setTimeout(checkPack, 1000);
	} , function (XHR, e) {
		console.log((XHR.status+e));
		setTimeout(checkPack, 1000);
	})
}
function packImages()
{
	postJSON("/tgz", {tgz:packID}, function(e, status){
		packSec=0;
        // if(language=="en"){
        //     $("#packSecMsg").html("Compressing "+packMacSec+" Photos，about "+packSec+" seconds");
        // }else{
        //     $("#packSecMsg").html("正在压缩"+packMacSec+"张照片，已用时"+packSec+"秒");
        // }
		if(language=="en"){
            $("#packSecMsg").html("<img src=\"images/netprompt.gif\">Compressing files...");
        }else{
            $("#packSecMsg").html("<img src=\"images/netprompt.gif\">正在压缩文件...");
        }
		setMiddle("#packing");
		setTimeout(checkPack, 1000);
	}, function (jqXHR, exception) {
		//error("EON not responsive!");
		setMiddle("#downloadError");
		console.log((jqXHR.status+exception));
	}, "text");
}

$("#downloadErrorConfirm,#sliceResultConfirm,#showMsgConfirm").on("click",function(){
	$(".dialog-poppup, .dialog-cover").hide();
});
/*
$("#sliceResultConfirm").on("click",function(){
        location.reload();
});
*/
$(".downloadCancel").on("click",function(){
	$(".dialog-poppup, .dialog-cover").hide();
});
$("#downloadConfirm").on("click",function(){
	$("#downloadPack, .dialog-cover").hide();
	packImages();
});

function askPack(id, amount)
{
	packID = id;
	packMacSec = parseInt(amount);
	console.log("压缩限制时间:"+packMacSec+"秒");
	setMiddle("#downloadPack");
	//setMiddle(".dialog-cover");
	//$("#downloadPack, .dialog-cover").show();
}

function checkSlice()
{
	if(packSec > packMacSec) {
		setMiddle("#sliceResult", "Time Slice Timeout!");
		return;
	}
	getJSON("/timeslice", function(e, status){
		packSec++;
		if(language=="en"){
			$("#sliceSecMsg").html("TimeSlice Processing "+e.progress+"%, about "+packSec+" seconds");
		}else{
			$("#sliceSecMsg").html("正在处理 "+e.progress+"%, 已用时"+packSec+"秒");
		}

		console.log("开始切片 "+e.progress+"%, 已用时"+packSec+"秒");
		if(e.folderID != packID ) {
			if(language=="en") setMiddle("#sliceResult", "Time Slice Failed!");
			else setMiddle("#sliceResult", "渐现生成失败!");
			console.log("切片ID错误 "+e.folderID+" "+packID);
		}
		else if(e.status == "done") {
			console.log("切片成功");
			if(language=="en"){
				setMiddle("#sliceResult", "Time Slice success!");
				$("#sliceResultMsg").html("Time Slice success! <br>"+"<a href='"+e.url+(getAccessToken()?'?access_token='+getAccessToken():'')+"' target='_blank'>Open "+id+"</a>");
			}else {
				setMiddle("#sliceResult", "切片成功!");
				$("#sliceResultMsg").html("切片成功！<br>"+"<a href='"+e.url+(getAccessToken()?'?access_token='+getAccessToken():'')+"' target='_blank'>打开"+id+"</a>");
			}
		}
		else setTimeout(checkSlice, 1000);
	} , function (XHR, e) {
		console.log((XHR.status+e));
		setTimeout(checkSlice, 1000);
	})

}
function timeslice(id, range, frame, seq, style)
{
	packID = id;
	//alert("folderID"+id+" style"+style+" frame"+frame+" range"+range+" seq"+seq);
	//return;
	postJSON("/timeslice", {"folderID":id, "style":style, "frame":frame, "range":range,"seq":seq}, function(e, status){
		packSec=0;
		if(language=="en"){
			setMiddle("#slicing", "TimeSlice Processing 0%, about "+packSec+" seconds");
		}else{
			setMiddle("#slicing", "正在处理 0%, 已用时"+packSec+"秒");
		}

		//setMiddle("#slicing", "开始切片 0%, 已用时"+packSec+"秒");
		setTimeout(checkSlice, 1000);
	}, function (jqXHR, exception) {
		//error("EON not responsive!");
		//setMiddle("#downloadError");
		console.log((jqXHR.status+exception));
	}, "text");

}

$(".folder-slice").on("click", function(){
	$(".slice").show();
	setInputsRy();
	updatePlusMinus();
});
function change_choose_pics(nums)
{
	if(nums>150) nums=150;
	$("#slice_count").attr("max", nums);
	console.log("slice_count:"+$("#slice_count").val()+" max:"+nums);
	if(parseInt($("#slice_count").val())>nums) $("#slice_count").val(nums);
	updatePlusMinus();
}
function updatePlusMinus()
{
	var rangeK = parseInt($("#slice_count").css("width")) / (parseInt($("#slice_count").attr("max"))-parseInt($("#slice_count").attr("min")));
	//alert($("#slice_count").css("width")+" "+(100+rangeK*$("#slice_count").val())+"px");
        $(".outputRange ").css("left", (100+rangeK*0.96*(parseInt($("#slice_count").val())-parseInt($("#slice_count").attr("min"))))+"px");
	$(".outputRange ").html($("#slice_count").val());
}
$(".choose-btn").on("click", function(){
	if(!id) return;
	var range = $("#range-start").val() +"-"+ $("#range-end").val();
	var seq = $(".tick.on").attr("v");
	var style = $(".choose-style .on").index();
	var frame = $("#slice_count").val();
	if(isNaN(parseInt(frame))){
		frame = $(".count").val();
		if(isNaN(parseInt(frame))) frame = 24;
	}
	timeslice(id, range, frame, seq, style);
})


  var mediaList = $('#mediaList');

  mediaList.empty();
  mediaList.append("<ul></ul>");

/*
$("#mediaList ul").on("load", ".folder-pic", function(){
	console.log("load ok !");
});
*/
function setItems(data)
{
	var index=0;
	while(index < data.length){
		console.log("check:"+data[index].id );
		var folder = data[index];
		if(data[index].id == id && data[index].type=="folder"){
			var i = 0;
			while(folder['timeslices'] && i < folder['timeslices'].length){
				//itemStr = '<li onClick="location.href=' + "'video_detail.html?id=" + mediaInfo.id + (getAccessToken()?'&access_token='+getAccessToken():'')+"'" + '"><div class="pic" style="background-image: url(' + "'/media/"+ folder.id +"/"+folder['timeslices'][i]+ (getAccessToken()?'?access_token='+getAccessToken():'')+');"></div>';
				//itemStr = '<li><div class="pic" style="background-image: url(' + "'/media/"+ folder.id +"/"+folder['timeslices'][i]+ (getAccessToken()?'?access_token='+getAccessToken():'')+');"></div>';
				var src = "/media/"+ folder.id +"/"+folder['timeslices'][i]+ (getAccessToken()?'?access_token='+getAccessToken():'');
				itemStr = '<li><div class="pic"><img class="folder-pic" src="'+src+'"/></div>';
				itemStr += '<div class="txt"><div class="time">'+ folder['timeslices'][i] +'</div></div>';
                		itemStr += '</li>';
                		$('#mediaList ul').append(itemStr);
				i++;
			}
			//url = folder.url;
			// var url = "/media/TLS6c289e000_200119143202/TLS_000000001.jpg"
			//var tail = url.substring(url.lastIndexOf("_") + 1, url.length); // TLS_000000001.jpg
			//var pre = url.substring(0, url.lastIndexOf("_") + 1);  // /media/TLS6c289e000_200119143202/
			//tail = tail.substring(0, tail.lastIndexOf(".")); // TLS_000000001
			var pre = "/media/"+id+"/";
			maxItems = folder.timelapse_end_index;
			folderShowItems=getParameterByName('c'); //手动设置过显示比例
			console.log("getParameterByName c:"+folderShowItems);
			if(!folderShowItems){ //默认比例
				if(maxItems <= 20) folderShowItems = 1;
				else if(maxItems <= 50) folderShowItems = 2;
				else if(maxItems <= 150) folderShowItems = 5;
				else if(maxItems <= 350) folderShowItems = 10;
				else if(maxItems <= 1000) folderShowItems = 25;
				else if(maxItems <=10000) folderShowItems = 100;
				//else if(maxItems <=20000) folderShowItems = 200;
				else folderShowItems = 200;
			}
			console.log("getParameterByName c:"+folderShowItems);
			$(".settings li[v="+folderShowItems+"]").addClass("on").siblings().removeClass("on");
			for (i = 0; i < maxItems; i++) {
				//console.log("check page:"+ i );
				if((i % folderShowItems) != 0 )continue;
				showItems++;
				var fileName = "TLS_" + ( "0000000000000000" + (i+1) ).substr(-9)+ ".jpg";
				var src = pre+fileName+(getAccessToken()?'?access_token='+getAccessToken():'');
				//itemStr = '<li onClick="location.href=' + "'video_detail.html?id=" +src+ "'"+'"><div class="pic" style="background-image: url('+src+');"></div>';
				//itemStr = '<li><div class="pic" style="background-image: url('+src+');"></div>';
				itemStr = '<li><div class="pic"><img class="folder-pic" src="'+src+'"/></div>';
				itemStr += '<div class="txt"><div class="time">'+fileName+'</div></div>';
				itemStr += '</li>';
				$('#mediaList ul').append(itemStr);
                        }
			$(".folder-pic").on("error", function(){
				console.log("load error !");
				$(this).attr("src", "/images/notfound.png");
			});
			$(".folder-pic").on("load", function(){
				console.log("naturalHeight:"+this.naturalHeight+" naturalWidth:"+this.naturalWidth);
				if(this.naturalHeight/this.naturalWidth > 0.5625){ //过高的图片需要按比例显示
					$(this).css("width", this.naturalWidth/(this.naturalHeight/0.5625)*100+"%");
				}
			});
            if(language=="en"){
                $("p[lan='foladr-head-msg']").text(maxItems+" in Total,"+showItems+" For Display");
            }else{
                $("p[lan='foladr-head-msg']").text("总数量"+maxItems+"帧，抽样显示"+showItems+"帧");
            }
			
			$("li[v]").each(function(){
				var v = parseInt(($(this).attr("v")));
				if(language=="en") {
					if(v!=1)  $(this).children("i").first().text("Select 1/"+v);
					$(this).children(".show-count").text("Display "+Math.ceil(maxItems/v)+"");
				}else {
					if(v!=1)  $(this).children("i").first().text("1/"+v+"抽样");
					$(this).children(".show-count").text("可展示"+Math.ceil(maxItems/v)+"帧");
				}
			})
			break;
		}
		index++;
	}
}


getJSON('/media2/', function(data) {
	console.log(data);
	mediaData=data;
	console.log("set start",mediaData);
	setItems(data);
	console.log("set end");
	setInputsRy();
}, function(err, status) {
	setInputsRy();
	console.log(err.status+status);
});

function setInputsRy(){
if(!maxItems || maxItems<1) maxItems = 80000;
//$("#range-msg").text("范围(1~"+maxItems+")");
$("#slice_count").attr("max", maxItems);
var inputsRy = {
    sliderWidth: 400,
    minRange: 1,
    maxRange: maxItems,
    outputWidth: 30, // output width
    thumbWidth: 30, // thumb width
    thumbBorderWidth: 4,
    trackHeight: 40,
    theValue: [1, maxItems] // theValue[0] < theValue[1]
};
var isDragging0 = false;
var isDragging1 = false;

// styles
var slider = document.querySelector(".slider");
var thumbs = document.querySelectorAll(".thumb");
var outputs = document.querySelectorAll(".output");
var track = document.querySelector(".track");
var range = inputsRy.maxRange - inputsRy.minRange;
var rangeK = inputsRy.sliderWidth / range;
var container = document.querySelector(".container");
var thumbRealWidth = inputsRy.thumbWidth + 2 * inputsRy.thumbBorderWidth;

updateValue();
$("#range-start, #range-end, .count").on("focusin", function(){
	$(this).css("width", "80px");
	$(this).select();
});
$("#range-start, #range-end").on("focusout", function(){
	if($(this).val()=="") $(this).val("1");
	inputsRy.theValue[0]=parseInt($("#range-start").val());
	inputsRy.theValue[1]=parseInt($("#range-end").val());
	updateValue();
});

$(".count").on("focusout", function(){
	if($(this).val()<=0) $(this).val(24);
	if($(this).val().length==0) $(this).val(24);
	$(this).css("width", $(this).val().length*12+15+"px");
});

$("#range-start, #range-end, .count").on("keyup", function(event){
	//$(this).css("width", $(this).val().length*12+15+"px");
	if(event.keyCode==13){
		$(this).blur();
	}
});
function updateValue()
{
inputsRy.sliderWidth = document.body.clientWidth * 0.8;
console.log("inputsRy.sliderWidth:"+inputsRy.sliderWidth);
range = inputsRy.maxRange - inputsRy.minRange;
rangeK = inputsRy.sliderWidth / range;
container = document.querySelector(".container");
thumbRealWidth = inputsRy.thumbWidth + 2 * inputsRy.thumbBorderWidth;

if(inputsRy.theValue[1]>inputsRy.maxRange) inputsRy.theValue[1]=inputsRy.maxRange;
if(inputsRy.theValue[0]>inputsRy.theValue[1]-12) inputsRy.theValue[0]=inputsRy.theValue[1]-12;
if(inputsRy.theValue[0]<inputsRy.minRange) inputsRy.theValue[0]=inputsRy.minRange;

slider.style.height = inputsRy.trackHeight + "px";
slider.style.width = inputsRy.sliderWidth + "px";
slider.style.paddingLeft = (inputsRy.theValue[0] - inputsRy.minRange) * rangeK + "px";
var v = inputsRy.sliderWidth - inputsRy.theValue[1] * rangeK;
slider.style.paddingRight = ((v<0)?0:v) + "px";
//console.log("inputsRy.sliderWidth:"+inputsRy.sliderWidth+" inputsRy.theValue[1]:"+inputsRy.theValue[1]+" rangeK:"+rangeK);
//slider.style.paddingRight = inputsRy.sliderWidth - inputsRy.theValue[1] * rangeK + "px";

track.style.width = inputsRy.theValue[1] * rangeK - inputsRy.theValue[0] * rangeK + "px";

for (var i = 0; i < thumbs.length; i++) {
    thumbs[i].style.width = thumbs[i].style.height = inputsRy.thumbWidth + "px";
    //thumbs[i].style.width = inputsRy.thumbWidth + "px";
    //thumbs[i].style.height = 30 + "px";
    //console.log(inputsRy.thumbWidth + "px");
    thumbs[i].style.borderWidth = inputsRy.thumbBorderWidth + "px";
    thumbs[i].style.top = -(inputsRy.thumbWidth / 2 + inputsRy.thumbBorderWidth - inputsRy.trackHeight / 2) + "px";
    //thumbs[i].style.top = 0;
    console.log("inputsRy.theValue[i]:"+inputsRy.theValue[i]+" inputsRy.minRange:"+inputsRy.minRange+" rangeK:"+rangeK+" thumbRealWidth:"+thumbRealWidth);
    thumbs[i].style.left = (inputsRy.theValue[i] - inputsRy.minRange) * rangeK - (thumbRealWidth / 2 -2) + "px";

}
for (var i = 0; i < outputs.length; i++) {
    outputs[i].style.width = outputs[i].style.height = outputs[i].style.lineHeight = outputs[i].style.left = inputsRy.outputWidth + "px";
    outputs[i].style.width = 3*inputsRy.outputWidth + "px";
    outputs[i].style.top = -(Math.sqrt(2 * inputsRy.outputWidth * inputsRy.outputWidth) + inputsRy.thumbWidth / 2 - inputsRy.trackHeight / 2) + "px";
    outputs[i].style.left = (inputsRy.theValue[i] - inputsRy.minRange) * rangeK - 1.5*inputsRy.outputWidth +5 + "px";
    //outputs[i].innerHTML = "<p>" + inputsRy.theValue[i] + "</p>";
}
	$("#range-start").val(inputsRy.theValue[0])
	$("#range-start").css("width", $("#range-start").val().length*12+15+"px");
	//console.log(inputsRy.theValue[0]+" "+$("#range-start").val().length+" "+$("#range-start").css("width"));
	$("#range-end").val(inputsRy.theValue[1]);
	$("#range-end").css("width", $("#range-end").val().length*12+15+"px");
	
	//$("#range-msg").text("范围("+inputsRy.theValue[0]+"~"+inputsRy.theValue[1]+")");
	change_choose_pics(inputsRy.theValue[1]-inputsRy.theValue[0]+1);
}

//events

thumbs[0].addEventListener("mousedown", function(evt) {
    isDragging0 = true;
}, false);
thumbs[1].addEventListener("mousedown", function(evt) {
    isDragging1 = true;
}, false);
document.body.addEventListener("mouseup", function(evt) {
    oMousePos(evt);
    isDragging0 = false;
    isDragging1 = false;
}, false);
container.addEventListener("mouseout", function(evt) {
    //isDragging0 = false;
    //isDragging1 = false;
}, false);

document.body.addEventListener("mousemove", function(evt) {
	if(!isDragging0 && !isDragging1) return;
	//console.log("mousemove X:"+evt.clientX+" Y:"+evt.clientX);
       // var mousePos = oMousePos(this, evt);
	oMousePos(evt);
}, false);
function oMousePos(evt){
    var ClientRect = container.getBoundingClientRect();
    mousePos= { //objeto
        x: Math.round(evt.clientX - ClientRect.left),
        y: Math.round(evt.clientY - ClientRect.top)
    }
	console.log("mousePos X:"+mousePos.x+" Y:"+mousePos.y);
    if(mousePos.x<0) mousePos.x=0; //最左边
    if(mousePos.x>slider.style.widtd) mousePos.x=slider.style.width;//最右边
    var theValue0 = (isDragging0) ? Math.round(mousePos.x / rangeK) + inputsRy.minRange : inputsRy.theValue[0];
    var theValue1 = (isDragging1) ? Math.round(mousePos.x / rangeK) + inputsRy.minRange : inputsRy.theValue[1];
    if(theValue1 > inputsRy.maxRange) theValue1 = inputsRy.maxRange;
   console.log("theValue:"+theValue0+" "+theValue1);

    if (isDragging0) {

        if (theValue0 < (theValue1 - (thumbRealWidth / 2)) &&
            theValue0 >= inputsRy.minRange) {
            inputsRy.theValue[0] = theValue0;
            updateValue();
        }
    } else if (isDragging1) {
	
        if (theValue1 > (theValue0 + (thumbRealWidth / 2)) &&
            theValue1 <= inputsRy.maxRange) {
            inputsRy.theValue[1] = theValue1;
            updateValue();
        }
    }

}

function setValue(theValue0, theValue1)
{
	if(theVale0 < inputsRy.minRange) theVale0=inputsRy.minRange;
	if(theVale0 > theValue1 - 12 ) theVale0=inputsRy.minRang;
	if(theVale0 < inputsRy.minRange) theVale0=inputsRy.minRange;
}

$("#slice_count").on("input propertychange", function(){
	updatePlusMinus();
})
$(".plus").on("click", function(){
	$("#slice_count").val(parseInt($("#slice_count").val())+1);
	updatePlusMinus();
});
$(".minus").on("click", function(){
	$("#slice_count").val(parseInt($("#slice_count").val())-1);
	updatePlusMinus();
});

// helpers
/*
function oMousePos(elmt, evt) {
    var ClientRect = elmt.getBoundingClientRect();
    return { //objeto
        x: Math.round(evt.clientX - ClientRect.left),
        y: Math.round(evt.clientY - ClientRect.top)
    }
}
*/
}

//以下是下载功能
    let endstatus = 0;
    
    var id = getParameterByName("id");
    async function BaiduClient(url = '', params = {}) {
        // 创建一个instance实例
        let instance = axios.create({
            baseURL: '/media/',
            responseType:"blob",
            // timeout: 20000
        })
        
        return await instance.request({
            url,
            params
        }).then(response => response).catch(err => err)
    }
    //判断是否手机端访问
    function isPhone() {
        //获取浏览器navigator对象的userAgent属性（浏览器用于HTTP请求的用户代理头的值）
        var info = navigator.userAgent;
        //通过正则表达式的test方法判断是否包含“Mobile”字符串
        var isPhone = /mobile/i.test(info);
        //如果包含“Mobile”（是手机设备）则返回true
        return isPhone;
    }
    $("#phoneConfirm").on("click",function(){
        $("#phonePrompt,.dialog-cover").hide();
    })
    $(".folder-download").on("click", function(){
        // if(id)
        //  askPack(id, maxItems);
        if(isPhone()){
            $("#phonePrompt,.dialog-cover").show();
            return;
        }
        $(".downloadPrepare,.dialog-cover").show();
        putJSON("/webctl",{"estimateFolderSize":id},function(xhr){
            getSizeStatus();
        },function(xhr){
            console.log("error:"+xhr.status);
        },"text");
    });
    $("#downloadCancel").on("click",function(){
        $("#beforeDownload,.dialog-cover").hide();
    });
    $("#doneConfirm").on("click",function(){
        $("#downloading,.dialog-cover").hide();
    })
    function getSizeStatus(){
        getJSON("/webctl?query=estimateFolderSize",function(d){
            if(!d[id+".size"]){
                 putJSON("/webctl",{"estimateFolderSize":id},function(xhr){
                    getSizeStatus();
                },function(xhr){
                    console.log("error:"+xhr.status);
                },"text");
            }else if(d[id+".size"]==0){
                setTimeout(getSizeStatus,1000);
            }else{
                $(".downloadPrepare,.dialog-cover").hide();
                var folderSize = renderSize2(d[id+".size"],1);
                console.log(folderSize+"=======================")
                $("#beforeDownload .content").html(language=="en"?("This files will take around "+folderSize+" spaces, please make sure there's sufficient disk space to complete operation."):("本次下载将占用大约"+folderSize+"，请确保足够的磁盘空间。"));
                $("#beforeDownload,.dialog-cover").show();
                
            }
        },function(xhr){
            console.log("error:"+xhr.status);
            setTimeout(getSizeStatus,1000);
        })
    }
    // $start.onclick = () => {
    $("#downloadYes").get(0).onclick = () => {
            download_running = true;
            console.log("get downloadYes click");
            $("#beforeDownload").hide();
            $("#downloading").show();
            $("#downloading .progressText").html(language=="en"?"Downloading...":"正在下载...");
            $("#downloading .failCount").hide().siblings(".downloadPrompt").show();
            getJSON('/media2/', function(data) {
                console.log('/media2/',data);
                // if(data.length&&data[0].timelapse_end_index){
                    // zipstart(data[0].timelapse_end_index,data[0].id)
                // }
                zipstart(maxItems,id);
            }, function(err, status) {
                
                console.log('media2请求失败',err.status+status);
            });
            // 定义一个Promise数组
            function zipstart(timelapse_end_index,zipName){
                const fileStream = streamSaver.createWriteStream(zipName? zipName+'.zip':'atli_folder_'+new Date().getTime()+'.zip')
                // const maxIndex = 60;
                const maxIndex = timelapse_end_index;
                $("#totalCount").html(maxIndex);
                let pms = []
                const readableZipStream = new ZIP({
                  async start (ctrl) {
                      
                    
                    let countSuccess = 0;
                    let countError = 0;
                    let chongshi = [];
                    for(let index=1;index<=maxIndex;index++){
                        let pms = []
                        let filename = "TLS_" + ( "0000000000000000" + (index) ).substr(-9)+ ".jpg";
                        if(endstatus==1){
                            console.log('下载结束?',endstatus);
                            break;
                            return;
                        }
                        // console.log('filename=',filename);
                        await BaiduClient(zipName+'/'+filename,{access_token:(getAccessToken()? getAccessToken():'')}).then(res=>{
                            console.log('请求结果',index, res,countSuccess,countError)
                            if(res.status==200){
                                var blob = new Blob([res.data])
                                var stream = () => blob.stream()
                                var name = zipName+'/'+filename;
                                ctrl.enqueue({ name, stream })
                                countSuccess++;
                                // $('#downloadProgress').text(countSuccess+'/'+maxIndex);
                                $("#comCount").text(countSuccess);
                                $("#downloading .progressSpan").css("width",(countSuccess/maxIndex*100)+"%");
                                return {res:true,url:index};
                            }
                            countError++;
                            //再次请求
                            BaiduClient(zipName+'/'+filename,{access_token:(getAccessToken()? getAccessToken():'')}).then(res=>{
                                console.log('再次请求结果',index, res,countSuccess)
                                if(res.status==200){
                                    var blob = new Blob([res.data])
                                    var stream = () => blob.stream()
                                    var name = zipName+'/'+filename;
                                    ctrl.enqueue({ name, stream })
                                    countSuccess++;
                                    // $('#downloadProgress').text(countSuccess+'/'+maxIndex);
                                    $("#comCount").text(countSuccess);
                                    $("#downloading .progressSpan").css("width",(countSuccess/maxIndex*100)+"%");
                                    countError--;
                                    return {res:true,url:index};
                                }
                                console.log('状态错误',index,res);
                                chongshi.push(index);
                            }).catch(err => {
                                console.log('再次错误' + err,index)
                            })
                            
                        }).catch(err => {
                                console.log('错误22' + err)
                        })
                        console.log('countSuccess=',countSuccess,'countError=',countError,'chongshi=',chongshi);
                        
                    }
                        
                    if(countSuccess==maxIndex){
                        console.log('全部下载打包','chongshi=',chongshi);
                    }else{
                        let pms3 = [];
                         chongshi.forEach((index)=>{
                            let filename = "TLS_" + ( "0000000000000000" + (index) ).substr(-9)+ ".jpg";
                            pms3.push(BaiduClient(zipName+'/'+filename,{access_token:(getAccessToken()? getAccessToken():'')}).then(res=>{
                                console.log('重试请求结果',index, res,countSuccess)
                                if(res.status==200){
                                    var blob = new Blob([res.data])
                                    var stream = () => blob.stream()
                                    var name = zipName+'/'+filename;
                                    ctrl.enqueue({ name, stream })
                                    countSuccess++;
                                    // $('#downloadProgress').text(countSuccess+'/'+maxIndex);
                                    $("#comCount").text(countSuccess);
                                    $("#downloading .progressSpan").css("width",(countSuccess/maxIndex*100)+"%");
                                    countError--;
                                    return {res:true,url:index};
                                }
                                console.log('重试状态错误',index,res);
                                return {res:false,url:index};
                            }).catch(err => {
                                console.log('重试错误' + err,index)
                            }))
                            
                        })
                        let pmsres3 = await Promise.all(pms3)
                        console.log('pmsres3=',pmsres3);
                        if(countSuccess==maxIndex){
                            console.log('全部下载完成','countSuccess=',countSuccess);
                        }else{
                            console.log('未全部下载','countError=',countError);
                        }
                        console.log('重试下载完成','chongshi=',chongshi,countSuccess,countError);
                        if(countError!==0){
                            $("#downloading .failCount").text(language=="en"?(countError+" items failed to download"):("其中有"+countError+"张照片下载失败")).show();
                        }
                    }
                    $("#downloading .progressText").text(language=="en"?"Download complete":"下载结束");
                    $("#downloading .downloadPrompt").hide().siblings(".btn").show();
                    ctrl.close()
                    download_running = false;
                  }
                })
                    
                // more optimized
                if (window.WritableStream && readableZipStream.pipeTo) {
                  return readableZipStream.pipeTo(fileStream).then(() => {
                      console.log('done writing')
                      return true;
                  }).catch(err => {
                      console.log('fileStreamErr' + err)
                      endstatus = 1;
                      return false;
                  })
                }
                    
                // less optimized
                const writer = fileStream.getWriter()
                const reader = readableZipStream.getReader()
                const pump = () => reader.read()
                  .then(res => {
                        res.done ? writer.close() : writer.write(res.value).then(pump); 
                        console.log('writerPump')
                  }).catch(err => {
                        console.log('fileStreamErr2' + err)
                  })
                    
                pump()
            }
            
        }
})
</script>

</body>
</html>




